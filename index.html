<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê† B·ªÉ C√° IoT - MQTT Web Interface v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        
        .connection-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #ddd;
        }
        
        .connection-status.connected {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .connection-status.disconnected {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .mqtt-config {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .mqtt-config h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .config-row input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .connect-btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 4px 0 #5568d3, 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .connect-btn:hover {
            box-shadow: 0 5px 0 #5568d3, 0 7px 15px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        
        .connect-btn:active {
            box-shadow: 0 1px 0 #5568d3, 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(3px);
        }
        
        .connect-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: 0 2px 0 #aaa;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .outlet-control {
            margin-bottom: 15px;
        }
        
        .outlet-name-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .outlet-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .outlet-btn.on {
            background: #28a745;
            color: white;
        }
        
        .outlet-btn.off {
            background: #dc3545;
            color: white;
        }
        
        .outlet-btn:hover:not(:disabled) {
            box-shadow: 0 5px 0 rgba(0,0,0,0.3), 0 7px 15px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        
        .outlet-btn:active:not(:disabled) {
            box-shadow: 0 1px 0 rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(3px);
        }
        
        .outlet-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        
        .schedule-item {
            background: #fff;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .schedule-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .schedule-row input[type="checkbox"] {
            transform: scale(1.3);
        }
        
        .schedule-row input[type="time"] {
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .schedule-row select {
            padding: 6px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .save-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .save-btn:hover:not(:disabled) {
            background: #5568d3;
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feed-btn {
            width: 100%;
            padding: 20px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 5px 0 #d64545, 0 8px 15px rgba(0,0,0,0.25);
        }
        
        .feed-btn:hover:not(:disabled) {
            box-shadow: 0 6px 0 #d64545, 0 10px 20px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }
        
        .feed-btn:active:not(:disabled) {
            box-shadow: 0 2px 0 #d64545, 0 4px 8px rgba(0,0,0,0.2);
            transform: translateY(3px);
        }
        
        .feed-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: 0 3px 0 #d64545;
        }
        
        .status {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
        }
        
        .status p {
            margin: 5px 0;
            color: #333;
        }
        
        .status strong {
            color: #667eea;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-entry.received {
            color: #00ff00;
        }
        
        .log-entry.sent {
            color: #ffff00;
        }
        
        .log-entry.error {
            color: #ff0000;
        }
        
        .info-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .badge-on {
            background: #28a745;
            color: white;
        }
        
        .badge-off {
            background: #dc3545;
            color: white;
        }
        
        .outlet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .outlet-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .edit-icon {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 3px 0 #5568d3, 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .edit-icon:hover {
            box-shadow: 0 4px 0 #5568d3, 0 6px 12px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        
        .edit-icon:active {
            box-shadow: 0 1px 0 #5568d3, 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(2px);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .modal-header h2 {
            color: #667eea;
            margin: 0;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 3px 0 #c82333, 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .close-btn:hover {
            box-shadow: 0 4px 0 #c82333, 0 6px 12px rgba(0,0,0,0.25);
            transform: translateY(-1px) rotate(90deg);
        }
        
        .close-btn:active {
            box-shadow: 0 1px 0 #c82333, 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(2px) rotate(90deg);
        }
        
        .modal-input-group {
            margin-bottom: 20px;
        }
        
        .modal-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-input-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-schedule-list {
            margin-top: 15px;
        }
        
        .modal-schedule-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .modal-schedule-row {
            display: grid;
            grid-template-columns: auto 1fr 1fr auto;
            gap: 10px;
            align-items: center;
        }
        
        .modal-schedule-row input[type="checkbox"] {
            transform: scale(1.5);
        }
        
        .modal-schedule-row input[type="time"],
        .modal-schedule-row select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-save-btn {
            flex: 1;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 4px 0 #1e7e34, 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .modal-save-btn:hover {
            box-shadow: 0 5px 0 #1e7e34, 0 7px 15px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        
        .modal-save-btn:active {
            box-shadow: 0 1px 0 #1e7e34, 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(3px);
        }
        
        .modal-cancel-btn {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            box-shadow: 0 4px 0 #545b62, 0 5px 10px rgba(0,0,0,0.2);
        }
        
        .modal-cancel-btn:hover {
            box-shadow: 0 5px 0 #545b62, 0 7px 15px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        
        .modal-cancel-btn:active {
            box-shadow: 0 1px 0 #545b62, 0 2px 5px rgba(0,0,0,0.2);
            transform: translateY(3px);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            font-size: 16px;
            font-weight: bold;
            z-index: 10000;
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.error {
            background: #dc3545;
        }
        
        .toast.info {
            background: #17a2b8;
        }
        
        .toast.warning {
            background: #ffc107;
            color: #333;
        }

        /* History Button */
        .history-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 4px 0 #117a8b, 0 5px 15px rgba(0,0,0,0.3);
            z-index: 999;
        }

        .history-btn:hover {
            box-shadow: 0 5px 0 #117a8b, 0 7px 20px rgba(0,0,0,0.35);
            transform: translateY(-2px);
        }

        .history-btn:active {
            box-shadow: 0 2px 0 #117a8b, 0 3px 8px rgba(0,0,0,0.25);
            transform: translateY(2px);
        }

        /* History Modal Styles */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .history-modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .history-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .history-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        .event-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .event-badge.outlet-on {
            background: #28a745;
            color: white;
        }

        .event-badge.outlet-off {
            background: #dc3545;
            color: white;
        }

        .event-badge.feeding {
            background: #ff6b6b;
            color: white;
        }

        .event-badge.schedule {
            background: #667eea;
            color: white;
        }

        .event-badge.rename {
            background: #ffc107;
            color: #333;
        }

        .history-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .history-loading .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .history-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .history-empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 3px 0 #1e7e34, 0 4px 8px rgba(0,0,0,0.2);
        }

        .refresh-btn:hover {
            box-shadow: 0 4px 0 #1e7e34, 0 6px 12px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }

        .refresh-btn:active {
            box-shadow: 0 1px 0 #1e7e34, 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(2px);
        }

        .history-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .history-count {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê† H·ªá Th·ªëng B·ªÉ C√° IoT v2.0 üê†</h1>
        
        <!-- C·∫•u h√¨nh MQTT -->
        <div class="mqtt-config">
            <h3>‚öôÔ∏è C·∫•u H√¨nh MQTT</h3>
            <div class="config-row">
                <input type="text" id="mqttBroker" placeholder="MQTT Broker (vd: test.mosquitto.org)" value="broker.hivemq.com" readonly>
                <input type="number" id="mqttPort" placeholder="WebSocket Port (vd: 8081)" value="8884" readonly>
            </div>
            <button class="connect-btn" id="connectBtn" onclick="toggleConnection()">K·∫øt N·ªëi MQTT</button>
        </div>
        <!-- Tr·∫°ng th√°i k·∫øt n·ªëi -->
        <div class="connection-status disconnected" id="connectionStatus">
            üî¥ Ch∆∞a k·∫øt n·ªëi - Vui l√≤ng k·∫øt n·ªëi MQTT
        </div>
        
        <!-- Giao di·ªán ƒëi·ªÅu khi·ªÉn -->
        <div class="grid">
            <!-- Outlet 1 -->
            <div class="card">
                <div class="outlet-header">
                    <div class="outlet-title" id="outlet1Title">‚ö° Outlet 1</div>
                    <button class="edit-icon" onclick="openEditModal(1)" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                </div>
                <button class="outlet-btn off" id="outlet1Btn" onclick="toggleOutlet(1)" disabled>
                    T·∫ÆT
                </button>
            </div>
            
            <!-- Outlet 2 -->
            <div class="card">
                <div class="outlet-header">
                    <div class="outlet-title" id="outlet2Title">‚ö° Outlet 2</div>
                    <button class="edit-icon" onclick="openEditModal(2)" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                </div>
                <button class="outlet-btn off" id="outlet2Btn" onclick="toggleOutlet(2)" disabled>
                    T·∫ÆT
                </button>
            </div>
            
            <!-- Outlet 3 -->
            <div class="card">
                <div class="outlet-header">
                    <div class="outlet-title" id="outlet3Title">‚ö° Outlet 3</div>
                    <button class="edit-icon" onclick="openEditModal(3)" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                </div>
                <button class="outlet-btn off" id="outlet3Btn" onclick="toggleOutlet(3)" disabled>
                    T·∫ÆT
                </button>
            </div>
            
            <!-- Outlet 4 -->
            <div class="card">
                <div class="outlet-header">
                    <div class="outlet-title" id="outlet4Title">‚ö° Outlet 4</div>
                    <button class="edit-icon" onclick="openEditModal(4)" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
                </div>
                <button class="outlet-btn off" id="outlet4Btn" onclick="toggleOutlet(4)" disabled>
                    T·∫ÆT
                </button>
            </div>
        </div>
        
        <!-- Cho ƒÉn v√† tr·∫°ng th√°i -->
        <div class="grid">
            <div class="card">
                <div class="outlet-header">
                    <div class="outlet-title">üçΩÔ∏è Cho C√° ƒÇn</div>
                    <button class="edit-icon" onclick="openFeedingModal()" title="Ch·ªânh s·ª≠a l·ªãch cho ƒÉn">‚úèÔ∏è</button>
                </div>
                <button class="feed-btn" onclick="feedFish()" disabled id="feedBtn">
                    CHO ƒÇN NGAY
                </button>
                <p style="margin-top: 15px; color: #666; text-align: center;">
                    L·∫ßn cho ƒÉn cu·ªëi: <strong id="lastFeed">Ch∆∞a c√≥</strong>
                </p>
            </div>
            
            <div class="card">
                <h2>üìä Tr·∫°ng Th√°i H·ªá Th·ªëng</h2>
                <div class="status">
                    <p><strong>ESP32 IP:</strong> <span id="espIP">ƒêang t·∫£i...</span></p>
                    <p><strong>WiFi Signal:</strong> <span id="wifiRSSI">ƒêang t·∫£i...</span></p>
                    <p><strong>MQTT Broker:</strong> <span id="brokerStatus">Ch∆∞a k·∫øt n·ªëi</span></p>
                    <p><strong>Last Update:</strong> <span id="lastUpdate">-</span></p>
                </div>
            </div>
        </div>
        
        <!-- Console Log -->
        <div class="log-container" id="logContainer">
            <div class="log-entry">üìù MQTT Console Log - S·∫µn s√†ng...</div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- History Button -->
    <button class="history-btn" onclick="openHistoryModal()" title="Xem l·ªãch s·ª≠ thay ƒë·ªïi">
        üìú L·ªãch S·ª≠
    </button>

    <!-- Modal L·ªãch S·ª≠ Thay ƒê·ªïi -->
    <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
            <div class="modal-header">
                <h2>üìú L·ªãch S·ª≠ Thay ƒê·ªïi</h2>
                <button class="close-btn" onclick="closeHistoryModal()">√ó</button>
            </div>
            
            <div class="history-header-row">
                <span class="history-count" id="historyCount">ƒêang t·∫£i...</span>
                <button class="refresh-btn" onclick="loadHistory()">üîÑ L√†m M·ªõi</button>
            </div>
            
            <div id="historyContent">
                <div class="history-loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ch·ªânh S·ª≠a Outlet -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">‚úèÔ∏è Ch·ªânh S·ª≠a Outlet 1</h2>
                <button class="close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            
            <div class="modal-input-group">
                <label>üìù T√™n Thi·∫øt B·ªã:</label>
                <input type="text" id="modalOutletName" placeholder="Nh·∫≠p t√™n thi·∫øt b·ªã...">
            </div>
            
            <div class="modal-input-group">
                <label>‚è∞ L·ªãch H·∫πn Gi·ªù:</label>
                <div class="modal-schedule-list" id="modalScheduleList">
                    <!-- 4 l·ªãch tr√¨nh s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closeEditModal()">H·ªßy</button>
                <button class="modal-save-btn" onclick="saveModalChanges()">üíæ L∆∞u Thay ƒê·ªïi</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ch·ªânh S·ª≠a L·ªãch Cho ƒÇn -->
    <div id="feedingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üçΩÔ∏è L·ªãch Cho C√° ƒÇn</h2>
                <button class="close-btn" onclick="closeFeedingModal()">√ó</button>
            </div>
            
            <div class="modal-input-group">
                <label>‚è∞ L·ªãch H·∫πn Gi·ªù Cho ƒÇn:</label>
                <div class="modal-schedule-list" id="feedingScheduleList">
                    <!-- 4 l·ªãch tr√¨nh cho ƒÉn s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-cancel-btn" onclick="closeFeedingModal()">H·ªßy</button>
                <button class="modal-save-btn" onclick="saveFeedingSchedule()">üíæ L∆∞u L·ªãch Cho ƒÇn</button>
            </div>
        </div>
    </div>

    <!-- Th∆∞ vi·ªán MQTT.js t·ª´ CDN -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <script>
        let mqttClient = null;
        let isConnected = false;
        let currentEditingOutlet = 1; // Outlet ƒëang ƒë∆∞·ª£c ch·ªânh s·ª≠a
        let outletNames = {
            1: "Outlet 1",
            2: "Outlet 2", 
            3: "Outlet 3",
            4: "Outlet 4"
        };
        
        // ===== BI·∫æN CHO L·ªÜNH CHO ƒÇN =====
        let pendingFeedId = null;  // ID l·ªánh cho ƒÉn ƒëang ch·ªù x√°c nh·∫≠n
        let feedTimeout = null;     // Timeout ƒë·ªÉ retry
        
        // ===== C·∫§U H√åNH GOOGLE SHEETS =====
        // CH·ªà C·∫¶N THAY ƒê·ªîI URL ·ªû ƒê√ÇY - m·ªôt ch·ªó duy nh·∫•t!
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw1_0NuTH3re4PzyXetknkizLStWS0a_cm0dDDfMpoS_QivnEIohizvpveHsKS3GFsgsw/exec';
        
        // Ki·ªÉm tra URL ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ch∆∞a (URL ph·∫£i ch·ª©a /macros/s/ v√† /exec)
        function isGoogleSheetsConfigured() {
            return GOOGLE_SCRIPT_URL && 
                   GOOGLE_SCRIPT_URL.includes('/macros/s/') && 
                   GOOGLE_SCRIPT_URL.includes('/exec');
        }
        
        // ===== GOOGLE SHEETS FUNCTIONS =====
        
        // Ghi log l√™n Google Sheets
        async function logToGoogleSheets(eventType, detail, value) {
            // Ki·ªÉm tra ƒë√£ c·∫•u h√¨nh ch∆∞a
            if (!isGoogleSheetsConfigured()) {
                console.warn('‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh Google Sheets URL. Xem file GOOGLE_SHEETS_SETUP.md');
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script y√™u c·∫ßu no-cors
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        eventType: eventType,
                        detail: detail,
                        value: value
                    })
                });
                
                console.log('üìù ƒê√£ ghi log: ', eventType, detail, value);
                
            } catch (error) {
                console.error('‚ùå L·ªói ghi log:', error);
            }
        }
        
        // ƒê·ªçc l·ªãch s·ª≠ t·ª´ Google Sheets
        async function fetchHistoryFromGoogleSheets() {
            // Ki·ªÉm tra ƒë√£ c·∫•u h√¨nh ch∆∞a
            if (!isGoogleSheetsConfigured()) {
                return { success: false, error: 'Ch∆∞a c·∫•u h√¨nh Google Sheets URL' };
            }
            
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?limit=100`, {
                    method: 'GET',
                });
                
                const data = await response.json();
                return data;
                
            } catch (error) {
                console.error('‚ùå L·ªói ƒë·ªçc l·ªãch s·ª≠:', error);
                return { success: false, error: error.message };
            }
        }
        
        // M·ªü modal l·ªãch s·ª≠
        function openHistoryModal() {
            document.getElementById('historyModal').style.display = 'block';
            loadHistory();
        }
        
        // ƒê√≥ng modal l·ªãch s·ª≠
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        // Load l·∫ßn cho ƒÉn cu·ªëi t·ª´ Google Sheets
        async function loadLastFeedingTime() {
            if (!isGoogleSheetsConfigured()) {
                // Th·ª≠ load t·ª´ localStorage
                const savedLastFeed = localStorage.getItem('lastFeedTime');
                if (savedLastFeed) {
                    document.getElementById('lastFeed').textContent = savedLastFeed;
                }
                return;
            }
            
            try {
                const result = await fetchHistoryFromGoogleSheets();
                
                if (result.success && result.data && result.data.length > 0) {
                    // T√¨m s·ª± ki·ªán "Cho c√° ƒÉn" g·∫ßn nh·∫•t
                    const feedEvent = result.data.find(item => 
                        item.eventType && item.eventType.toLowerCase().includes('cho c√° ƒÉn')
                    );
                    
                    if (feedEvent && feedEvent.timestamp) {
                        document.getElementById('lastFeed').textContent = feedEvent.timestamp;
                        // L∆∞u v√†o localStorage ƒë·ªÉ hi·ªÉn th·ªã nhanh l·∫ßn sau
                        localStorage.setItem('lastFeedTime', feedEvent.timestamp);
                    } else {
                        // Kh√¥ng c√≥ s·ª± ki·ªán cho ƒÉn, th·ª≠ load t·ª´ localStorage
                        const savedLastFeed = localStorage.getItem('lastFeedTime');
                        if (savedLastFeed) {
                            document.getElementById('lastFeed').textContent = savedLastFeed;
                        }
                    }
                }
            } catch (error) {
                console.error('L·ªói load l·∫ßn cho ƒÉn cu·ªëi:', error);
                // Fallback: load t·ª´ localStorage
                const savedLastFeed = localStorage.getItem('lastFeedTime');
                if (savedLastFeed) {
                    document.getElementById('lastFeed').textContent = savedLastFeed;
                }
            }
        }
        
        // Load v√† hi·ªÉn th·ªã l·ªãch s·ª≠
        async function loadHistory() {
            const contentDiv = document.getElementById('historyContent');
            const countSpan = document.getElementById('historyCount');
            
            // Hi·ªÉn th·ªã loading
            contentDiv.innerHTML = `
                <div class="history-loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
                </div>
            `;
            countSpan.textContent = 'ƒêang t·∫£i...';
            
            // Ki·ªÉm tra c·∫•u h√¨nh
            if (!isGoogleSheetsConfigured()) {
                contentDiv.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">‚öôÔ∏è</div>
                        <p><strong>Ch∆∞a c·∫•u h√¨nh Google Sheets</strong></p>
                        <p style="margin-top: 10px; font-size: 14px;">
                            Vui l√≤ng xem file <code>GOOGLE_SHEETS_SETUP.md</code> ƒë·ªÉ thi·∫øt l·∫≠p.
                        </p>
                    </div>
                `;
                countSpan.textContent = 'Ch∆∞a c·∫•u h√¨nh';
                return;
            }
            
            // Fetch d·ªØ li·ªáu
            const result = await fetchHistoryFromGoogleSheets();
            
            if (!result.success) {
                contentDiv.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">‚ùå</div>
                        <p><strong>L·ªói t·∫£i l·ªãch s·ª≠</strong></p>
                        <p style="margin-top: 10px; font-size: 14px; color: #dc3545;">
                            ${result.error || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheets'}
                        </p>
                    </div>
                `;
                countSpan.textContent = 'L·ªói';
                return;
            }
            
            const history = result.data || [];
            
            if (history.length === 0) {
                contentDiv.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon">üì≠</div>
                        <p><strong>Ch∆∞a c√≥ l·ªãch s·ª≠</strong></p>
                        <p style="margin-top: 10px; font-size: 14px;">
                            C√°c thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c ghi l·∫°i t·∫°i ƒë√¢y.
                        </p>
                    </div>
                `;
                countSpan.textContent = '0 s·ª± ki·ªán';
                return;
            }
            
            // Hi·ªÉn th·ªã b·∫£ng l·ªãch s·ª≠
            countSpan.textContent = `${history.length} s·ª± ki·ªán g·∫ßn nh·∫•t`;
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th style="width: 180px;">Th·ªùi gian</th>
                            <th style="width: 150px;">Lo·∫°i s·ª± ki·ªán</th>
                            <th>Chi ti·∫øt</th>
                            <th style="width: 120px;">Gi√° tr·ªã</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            history.forEach(item => {
                const badgeClass = getEventBadgeClass(item.eventType);
                tableHTML += `
                    <tr>
                        <td>${item.timestamp || ''}</td>
                        <td><span class="event-badge ${badgeClass}">${item.eventType || ''}</span></td>
                        <td>${item.detail || ''}</td>
                        <td><strong>${item.value || ''}</strong></td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            contentDiv.innerHTML = tableHTML;
        }
        
        // L·∫•y CSS class cho badge d·ª±a tr√™n lo·∫°i s·ª± ki·ªán
        function getEventBadgeClass(eventType) {
            if (!eventType) return '';
            
            const type = eventType.toLowerCase();
            
            if (type.includes('b·∫≠t') || type.includes('on')) return 'outlet-on';
            if (type.includes('t·∫Øt') || type.includes('off')) return 'outlet-off';
            if (type.includes('ƒÉn') || type.includes('feed')) return 'feeding';
            if (type.includes('l·ªãch') || type.includes('schedule')) return 'schedule';
            if (type.includes('t√™n') || type.includes('name') || type.includes('rename')) return 'rename';
            
            return '';
        }
        
        // Click b√™n ngo√†i history modal ƒë·ªÉ ƒë√≥ng
        window.addEventListener('click', function(event) {
            const historyModal = document.getElementById('historyModal');
            if (event.target === historyModal) {
                closeHistoryModal();
            }
        });
        
        // H√†m hi·ªÉn th·ªã toast notification
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            // Hi·ªÉn th·ªã toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // T·ª± ƒë·ªông ·∫©n sau duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, duration);
        }
        
        // T·∫°o giao di·ªán 4 l·ªãch tr√¨nh trong modal
        function createModalSchedules() {
            const container = document.getElementById('modalScheduleList');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const scheduleDiv = document.createElement('div');
                scheduleDiv.className = 'modal-schedule-item';
                scheduleDiv.innerHTML = `
                    <div class="modal-schedule-row">
                        <input type="checkbox" id="modal_s${i}_enable">
                        <input type="time" id="modal_s${i}_time" value="00:00">
                        <select id="modal_s${i}_action">
                            <option value="true">B·∫¨T</option>
                            <option value="false">T·∫ÆT</option>
                        </select>
                        <span style="font-size: 12px; color: #666;">L·ªãch ${i+1}</span>
                    </div>
                `;
                container.appendChild(scheduleDiv);
            }
        }
        
        // T·∫°o giao di·ªán l·ªãch cho ƒÉn
        function createFeedingSchedules() {
            const container = document.getElementById('feedingScheduleList');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const scheduleDiv = document.createElement('div');
                scheduleDiv.className = 'modal-schedule-item';
                scheduleDiv.innerHTML = `
                    <div class="modal-schedule-row" style="grid-template-columns: auto 1fr auto;">
                        <input type="checkbox" id="feeding_s${i}_enable">
                        <input type="time" id="feeding_s${i}_time" value="00:00">
                        <span style="font-size: 12px; color: #666;">L·ªãch ${i+1}</span>
                    </div>
                `;
                container.appendChild(scheduleDiv);
            }
        }
        
        // M·ªü modal ch·ªânh s·ª≠a
        function openEditModal(outlet) {
            currentEditingOutlet = outlet;
            
            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ modal
            document.getElementById('modalTitle').textContent = `‚úèÔ∏è Ch·ªânh S·ª≠a ${outletNames[outlet]}`;
            
            // Load t√™n hi·ªán t·∫°i
            document.getElementById('modalOutletName').value = outletNames[outlet];
            
            // Load l·ªãch tr√¨nh hi·ªán t·∫°i
            for (let i = 0; i < 4; i++) {
                const enabledEl = document.getElementById(`modal_s${i}_enable`);
                const timeEl = document.getElementById(`modal_s${i}_time`);
                const actionEl = document.getElementById(`modal_s${i}_action`);
                
                // L·∫•y d·ªØ li·ªáu t·ª´ localStorage (cache)
                const scheduleKey = `outlet${outlet}_schedule${i}`;
                const savedSchedule = localStorage.getItem(scheduleKey);
                
                if (savedSchedule) {
                    const schedule = JSON.parse(savedSchedule);
                    enabledEl.checked = schedule.enabled;
                    timeEl.value = schedule.time;
                    actionEl.value = String(schedule.action);
                } else {
                    enabledEl.checked = false;
                    timeEl.value = '00:00';
                    actionEl.value = 'true';
                }
            }
            
            // Hi·ªÉn th·ªã modal
            document.getElementById('editModal').style.display = 'block';
        }
        
        // ƒê√≥ng modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // M·ªü modal l·ªãch cho ƒÉn
        function openFeedingModal() {
            // Load l·ªãch cho ƒÉn hi·ªán t·∫°i t·ª´ localStorage
            for (let i = 0; i < 4; i++) {
                const scheduleKey = `feeding_schedule${i}`;
                const savedSchedule = localStorage.getItem(scheduleKey);
                
                if (savedSchedule) {
                    const schedule = JSON.parse(savedSchedule);
                    document.getElementById(`feeding_s${i}_enable`).checked = schedule.enabled;
                    document.getElementById(`feeding_s${i}_time`).value = schedule.time;
                } else {
                    document.getElementById(`feeding_s${i}_enable`).checked = false;
                    document.getElementById(`feeding_s${i}_time`).value = '00:00';
                }
            }
            
            document.getElementById('feedingModal').style.display = 'block';
        }
        
        // ƒê√≥ng modal l·ªãch cho ƒÉn
        function closeFeedingModal() {
            document.getElementById('feedingModal').style.display = 'none';
        }
        
        // L∆∞u l·ªãch cho ƒÉn
        function saveFeedingSchedule() {
            if (!mqttClient || !isConnected) {
                showToast('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MQTT tr∆∞·ªõc!', 'warning');
                return;
            }
            
            // T·∫°o ƒë·ªëi t∆∞·ª£ng schedules ƒë·∫ßy ƒë·ªß
            const schedules = {};
            
            // L·∫•y l·ªãch tr√¨nh outlets t·ª´ localStorage
            for (let o = 1; o <= 4; o++) {
                schedules[`outlet${o}`] = [];
                for (let i = 0; i < 4; i++) {
                    const scheduleKey = `outlet${o}_schedule${i}`;
                    const savedSchedule = localStorage.getItem(scheduleKey);
                    if (savedSchedule) {
                        const s = JSON.parse(savedSchedule);
                        const time = s.time.split(':');
                        schedules[`outlet${o}`].push({
                            enabled: s.enabled,
                            hour: parseInt(time[0]),
                            minute: parseInt(time[1]),
                            action: s.action
                        });
                    } else {
                        schedules[`outlet${o}`].push({
                            enabled: false,
                            hour: 0,
                            minute: 0,
                            action: true
                        });
                    }
                }
            }
            
            // Th√™m l·ªãch cho ƒÉn
            schedules.feeding = [];
            const feedingTimes = [];
            for (let i = 0; i < 4; i++) {
                const enabled = document.getElementById(`feeding_s${i}_enable`).checked;
                const timeValue = document.getElementById(`feeding_s${i}_time`).value;
                const time = timeValue.split(':');
                
                schedules.feeding.push({
                    enabled: enabled,
                    hour: parseInt(time[0]),
                    minute: parseInt(time[1])
                });
                
                // Thu th·∫≠p c√°c l·ªãch ƒë√£ b·∫≠t ƒë·ªÉ log
                if (enabled) {
                    feedingTimes.push(timeValue);
                }
                
                // L∆∞u v√†o localStorage
                const scheduleKey = `feeding_schedule${i}`;
                localStorage.setItem(scheduleKey, JSON.stringify({
                    enabled: enabled,
                    time: timeValue
                }));
            }
            
            // G·ª≠i qua MQTT v·ªõi retained flag
            mqttClient.publish('fishfeeder/schedule', JSON.stringify(schedules), { retain: true });
            addLog('üì§ L∆∞u l·ªãch cho ƒÉn', 'sent');
            
            // Ghi log l·ªãch cho ƒÉn l√™n Google Sheets
            const feedingSummary = feedingTimes.length > 0 
                ? feedingTimes.join(', ') 
                : 'Kh√¥ng c√≥ l·ªãch';
            logToGoogleSheets('C·∫≠p nh·∫≠t l·ªãch cho ƒÉn', 'Feeding Schedule', feedingSummary);
            
            closeFeedingModal();
            showToast('‚úÖ ƒê√£ l∆∞u l·ªãch cho ƒÉn!', 'success');
        }
        
        // L∆∞u thay ƒë·ªïi t·ª´ modal
        function saveModalChanges() {
            if (!mqttClient || !isConnected) {
                showToast('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MQTT tr∆∞·ªõc!', 'warning');
                return;
            }
            
            const outlet = currentEditingOutlet;
            const oldName = outletNames[outlet];
            
            // L∆∞u t√™n m·ªõi - PUBLISH V√ÄO TOPIC RI√äNG
            const newName = document.getElementById('modalOutletName').value.trim();
            if (newName) {
                outletNames[outlet] = newName;
                document.getElementById(`outlet${outlet}Title`).textContent = `‚ö° ${newName}`;
                
                // G·ª≠i t√™n qua MQTT v√†o topic ri√™ng v·ªõi retained flag
                mqttClient.publish(`fishfeeder/outlet${outlet}/name`, newName, { retain: true });
                addLog(`üì§ C·∫≠p nh·∫≠t t√™n outlet ${outlet}: ${newName}`, 'sent');
                
                // Ghi log ƒë·ªïi t√™n l√™n Google Sheets (ch·ªâ khi t√™n thay ƒë·ªïi)
                if (newName !== oldName) {
                    logToGoogleSheets('ƒê·ªïi t√™n', `Outlet ${outlet}`, `${oldName} ‚Üí ${newName}`);
                }
            }
            
            // L∆∞u l·ªãch tr√¨nh - CH·ªà L∆ØU OUTLET ƒêANG EDIT
            const schedules = [];
            
            for (let i = 0; i < 4; i++) {
                const enabled = document.getElementById(`modal_s${i}_enable`).checked;
                const timeValue = document.getElementById(`modal_s${i}_time`).value;
                const action = document.getElementById(`modal_s${i}_action`).value === 'true';
                
                // Cache v√†o localStorage
                const scheduleKey = `outlet${outlet}_schedule${i}`;
                localStorage.setItem(scheduleKey, JSON.stringify({
                    enabled: enabled,
                    time: timeValue,
                    action: action
                }));
                
                const time = timeValue.split(':');
                schedules.push({
                    enabled: enabled,
                    hour: parseInt(time[0]),
                    minute: parseInt(time[1]),
                    action: action
                });
            }
            
            // G·ª≠i l·ªãch tr√¨nh v√†o topic ri√™ng v·ªõi retained flag
            const scheduleJSON = JSON.stringify({ schedules: schedules });
            mqttClient.publish(`fishfeeder/outlet${outlet}/schedule`, scheduleJSON, { retain: true });
            addLog(`üì§ L∆∞u l·ªãch tr√¨nh Outlet ${outlet}`, 'sent');
            
            // Ghi log c·∫≠p nh·∫≠t l·ªãch l√™n Google Sheets
            const enabledSchedules = schedules.filter(s => s.enabled);
            const schedulesSummary = enabledSchedules.length > 0 
                ? enabledSchedules.map(s => `${String(s.hour).padStart(2,'0')}:${String(s.minute).padStart(2,'0')} ${s.action ? 'B·∫¨T' : 'T·∫ÆT'}`).join(', ')
                : 'Kh√¥ng c√≥ l·ªãch';
            logToGoogleSheets('C·∫≠p nh·∫≠t l·ªãch', outletNames[outlet], schedulesSummary);
            
            // ƒê√≥ng modal
            closeEditModal();
            showToast(`‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t ${outletNames[outlet]}!`, 'success');
        }
        
        // Click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
            const feedingModal = document.getElementById('feedingModal');
            
            if (event.target === editModal) {
                closeEditModal();
            }
            if (event.target === feedingModal) {
                closeFeedingModal();
            }
        }
        
        // Kh·ªüi t·∫°o modal schedules
        createModalSchedules();
        createFeedingSchedules();
        
        // H√†m log
        function addLog(message, type = 'received') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Gi·ªõi h·∫°n 100 d√≤ng log
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // K·∫øt n·ªëi/Ng·∫Øt k·∫øt n·ªëi MQTT
        function toggleConnection() {
            if (isConnected) {
                disconnectMQTT();
            } else {
                connectMQTT();
            }
        }
        
        // K·∫øt n·ªëi MQTT
        function connectMQTT() {
            const broker = document.getElementById('mqttBroker').value;
            let port = document.getElementById('mqttPort').value;
            const clientId = 'WebClient_' + Math.random().toString(16).substr(2, 8);
            // Username v√† password ƒë√£ b·ªã ·∫©n ho√†n to√†n
            // T·ª± ƒë·ªông ch·ªçn ws:// ho·∫∑c wss:// d·ª±a tr√™n trang hi·ªán t·∫°i
            let protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            // N·∫øu d√πng HTTPS v√† port l√† 8081 (WS th∆∞·ªùng), t·ª± ƒë·ªông ƒë·ªïi sang port WSS
            if (window.location.protocol === 'https:' && port === '8081') {
                if (broker.includes('hivemq')) {
                    port = '8884'; // HiveMQ WSS port
                    addLog('‚ÑπÔ∏è T·ª± ƒë·ªông chuy·ªÉn sang port WSS: 8884', 'sent');
                } else if (broker.includes('emqx')) {
                    port = '8084'; // EMQX WSS port
                    addLog('‚ÑπÔ∏è T·ª± ƒë·ªông chuy·ªÉn sang port WSS: 8084', 'sent');
                }
            }
            const url = `${protocol}${broker}:${port}/mqtt`;
            addLog(`ƒêang k·∫øt n·ªëi ƒë·∫øn ${url}...`, 'sent');
            const options = {
                clientId: clientId,
                clean: true,
                reconnectPeriod: 5000,
            };
            // Kh√¥ng truy·ªÅn username/password
            mqttClient = mqtt.connect(url, options);
            mqttClient.on('connect', () => {
                isConnected = true;
                updateConnectionStatus(true);
                addLog('‚úÖ ƒê√£ k·∫øt n·ªëi MQTT th√†nh c√¥ng!', 'received');
                
                // Subscribe c√°c topic STATUS ri√™ng ƒë·ªÉ nh·∫≠n tr·∫°ng th√°i
                mqttClient.subscribe('fishfeeder/outlet1/status', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet1/status', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet2/status', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet2/status', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet3/status', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet3/status', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet4/status', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet4/status', 'received');
                });
                
                // Subscribe c√°c topic SCHEDULE ri√™ng
                mqttClient.subscribe('fishfeeder/outlet1/schedule', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet1/schedule', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet2/schedule', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet2/schedule', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet3/schedule', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet3/schedule', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet4/schedule', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet4/schedule', 'received');
                });
                
                // Subscribe c√°c topic NAME ri√™ng
                mqttClient.subscribe('fishfeeder/outlet1/name', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet1/name', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet2/name', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet2/name', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet3/name', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet3/name', 'received');
                });
                mqttClient.subscribe('fishfeeder/outlet4/name', (err) => {
                    if (!err) addLog('üì• Subscribed: outlet4/name', 'received');
                });
                
                // Subscribe topic th√¥ng tin thi·∫øt b·ªã
                mqttClient.subscribe('fishfeeder/info', (err) => {
                    if (!err) addLog('üì• Subscribed: fishfeeder/info', 'received');
                });
                
                // Subscribe topic ACK cho ƒÉn
                mqttClient.subscribe('fishfeeder/feed/ack', (err) => {
                    if (!err) addLog('üì• Subscribed: fishfeeder/feed/ack', 'received');
                });
                
                enableControls(true);
            });
            
            mqttClient.on('message', (topic, message) => {
                const msg = message.toString();
                addLog(`üì© ${topic}: ${msg.substring(0, 100)}${msg.length > 100 ? '...' : ''}`, 'received');
                handleMQTTMessage(topic, msg);
            });
            
            mqttClient.on('error', (err) => {
                addLog(`‚ùå L·ªói: ${err.message}`, 'error');
                
                // Ki·ªÉm tra l·ªói Mixed Content
                if (window.location.protocol === 'https:' && err.message.includes('WebSocket')) {
                    addLog(`‚ö†Ô∏è L·ªói b·∫£o m·∫≠t: Trang HTTPS kh√¥ng th·ªÉ k·∫øt n·ªëi WS (kh√¥ng m√£ h√≥a)`, 'error');
                    addLog(`üí° Gi·∫£i ph√°p: ƒê·ªïi broker sang WSS ho·∫∑c d√πng trang HTTP local`, 'error');
                    showToast('‚ö†Ô∏è L·ªói Mixed Content: C·∫ßn broker h·ªó tr·ª£ WSS (port 8883/8884)', 'error', 5000);
                }
            });
            
            mqttClient.on('close', () => {
                isConnected = false;
                updateConnectionStatus(false);
                addLog('üî¥ ƒê√£ ng·∫Øt k·∫øt n·ªëi MQTT', 'error');
                enableControls(false);
            });
        }
        
        // Ng·∫Øt k·∫øt n·ªëi MQTT
        function disconnectMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const brokerStatus = document.getElementById('brokerStatus');
            
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.innerHTML = 'üü¢ ƒê√£ k·∫øt n·ªëi MQTT - S·∫µn s√†ng ƒëi·ªÅu khi·ªÉn';
                connectBtn.textContent = 'Ng·∫Øt K·∫øt N·ªëi';
                const broker = document.getElementById('mqttBroker').value;
                brokerStatus.textContent = `${broker} (ƒê√£ k·∫øt n·ªëi)`;
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.innerHTML = 'üî¥ Ch∆∞a k·∫øt n·ªëi - Vui l√≤ng k·∫øt n·ªëi MQTT';
                connectBtn.textContent = 'K·∫øt N·ªëi MQTT';
                brokerStatus.textContent = 'Ch∆∞a k·∫øt n·ªëi';
            }
        }
        
        // B·∫≠t/t·∫Øt c√°c n√∫t ƒëi·ªÅu khi·ªÉn
        function enableControls(enabled) {
            const buttons = ['outlet1Btn', 'outlet2Btn', 'outlet3Btn', 'outlet4Btn', 'feedBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !enabled;
            });
        }
        
        // X·ª≠ l√Ω tin nh·∫Øn MQTT
        function handleMQTTMessage(topic, message) {
            // ===== X·ª¨ L√ù STATUS RI√äNG T·ª™NG OUTLET =====
            if (topic === 'fishfeeder/outlet1/status') {
                updateOutletButton(1, message === 'ON');
            } else if (topic === 'fishfeeder/outlet2/status') {
                updateOutletButton(2, message === 'ON');
            } else if (topic === 'fishfeeder/outlet3/status') {
                updateOutletButton(3, message === 'ON');
            } else if (topic === 'fishfeeder/outlet4/status') {
                updateOutletButton(4, message === 'ON');
            }
            
            // ===== X·ª¨ L√ù SCHEDULE RI√äNG T·ª™NG OUTLET =====
            else if (topic === 'fishfeeder/outlet1/schedule') {
                handleOutletScheduleMessage(1, message);
            } else if (topic === 'fishfeeder/outlet2/schedule') {
                handleOutletScheduleMessage(2, message);
            } else if (topic === 'fishfeeder/outlet3/schedule') {
                handleOutletScheduleMessage(3, message);
            } else if (topic === 'fishfeeder/outlet4/schedule') {
                handleOutletScheduleMessage(4, message);
            }
            
            // ===== X·ª¨ L√ù NAME RI√äNG T·ª™NG OUTLET =====
            else if (topic === 'fishfeeder/outlet1/name') {
                outletNames[1] = message;
                document.getElementById('outlet1Title').textContent = `‚ö° ${message}`;
            } else if (topic === 'fishfeeder/outlet2/name') {
                outletNames[2] = message;
                document.getElementById('outlet2Title').textContent = `‚ö° ${message}`;
            } else if (topic === 'fishfeeder/outlet3/name') {
                outletNames[3] = message;
                document.getElementById('outlet3Title').textContent = `‚ö° ${message}`;
            } else if (topic === 'fishfeeder/outlet4/name') {
                outletNames[4] = message;
                document.getElementById('outlet4Title').textContent = `‚ö° ${message}`;
            }
            
            // ===== X·ª¨ L√ù TH√îNG TIN THI·∫æT B·ªä =====
            else if (topic === 'fishfeeder/info') {
                try {
                    const data = JSON.parse(message);
                    document.getElementById('espIP').textContent = data.ip || 'N/A';
                    document.getElementById('wifiRSSI').textContent = data.rssi ? `${data.rssi} dBm` : 'N/A';
                    
                    // Hi·ªÉn th·ªã ng√†y gi·ªù ƒë·∫ßy ƒë·ªß
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('vi-VN');
                    const timeStr = now.toLocaleTimeString('vi-VN');
                    document.getElementById('lastUpdate').textContent = `${dateStr} ${timeStr}`;
                } catch (e) {
                    addLog(`‚ö†Ô∏è L·ªói parse info: ${e}`, 'error');
                }
            }
            
            // ===== X·ª¨ L√ù ACK CHO ƒÇN =====
            else if (topic === 'fishfeeder/feed/ack') {
                // Nh·∫≠n x√°c nh·∫≠n ƒë√£ cho ƒÉn t·ª´ ESP
                if (message === pendingFeedId) {
                    addLog(`‚úÖ X√°c nh·∫≠n ƒë√£ cho ƒÉn: ${message}`, 'received');
                    showToast('‚úÖ C√° ƒë√£ ƒë∆∞·ª£c cho ƒÉn th√†nh c√¥ng!', 'success');
                    
                    // Hi·ªÉn th·ªã ng√†y gi·ªù ƒë·∫ßy ƒë·ªß
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('vi-VN'); // dd/mm/yyyy
                    const timeStr = now.toLocaleTimeString('vi-VN'); // hh:mm:ss
                    const lastFeedStr = `${dateStr} ${timeStr}`;
                    document.getElementById('lastFeed').textContent = lastFeedStr;
                    
                    // L∆∞u v√†o localStorage ƒë·ªÉ hi·ªÉn th·ªã khi load l·∫°i trang
                    localStorage.setItem('lastFeedTime', lastFeedStr);
                    
                    // Ghi log l√™n Google Sheets (ch·ªâ khi cho ƒÉn th√†nh c√¥ng)
                    logToGoogleSheets('Cho c√° ƒÉn', 'Feeding', lastFeedStr);
                    
                    // Reset tr·∫°ng th√°i ch·ªù
                    pendingFeedId = null;
                    const feedBtn = document.getElementById('feedBtn');
                    feedBtn.disabled = false;
                    feedBtn.textContent = 'CHO ƒÇN NGAY';
                }
            }
        }
        
        // X·ª≠ l√Ω schedule message cho 1 outlet
        function handleOutletScheduleMessage(outlet, message) {
            try {
                const data = JSON.parse(message);
                const schedules = data.schedules;
                
                if (schedules && Array.isArray(schedules)) {
                    for (let i = 0; i < 4 && i < schedules.length; i++) {
                        const s = schedules[i];
                        const timeValue = `${String(s.hour || 0).padStart(2,'0')}:${String(s.minute || 0).padStart(2,'0')}`;
                        
                        // L∆∞u v√†o localStorage
                        const scheduleKey = `outlet${outlet}_schedule${i}`;
                        localStorage.setItem(scheduleKey, JSON.stringify({
                            enabled: s.enabled || false,
                            time: timeValue,
                            action: s.action
                        }));
                    }
                    addLog(`‚úÖ ƒê√£ load l·ªãch tr√¨nh outlet ${outlet}`, 'received');
                }
            } catch (e) {
                addLog(`‚ö†Ô∏è L·ªói parse schedule outlet ${outlet}: ${e}`, 'error');
            }
        }
        
        // C·∫≠p nh·∫≠t n√∫t outlet
        function updateOutletButton(outlet, state) {
            const btn = document.getElementById(`outlet${outlet}Btn`);
            if (!btn) return;
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† k√≠ch ho·∫°t l·∫°i n√∫t (t·ª´ tr·∫°ng th√°i "ƒëang ch·ªù")
            btn.disabled = false;
            btn.className = 'outlet-btn ' + (state ? 'on' : 'off');
            btn.textContent = state ? 'B·∫¨T' : 'T·∫ÆT';
        }
        
        // Toggle outlet
        function toggleOutlet(outlet) {
            if (!mqttClient || !isConnected) {
                showToast('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MQTT tr∆∞·ªõc!', 'warning');
                return;
            }
            
            const btn = document.getElementById(`outlet${outlet}Btn`);
            const currentState = btn.classList.contains('on');
            const newState = !currentState;
            
            // G·ª¨I l·ªánh v√†o topic control ri√™ng
            // Ch·ªù ESP32 ph·∫£n h·ªìi qua topic fishfeeder/outletX/status
            mqttClient.publish(`fishfeeder/outlet${outlet}/control`, newState ? 'ON' : 'OFF');
            addLog(`üì§ G·ª≠i: outlet${outlet}/control = ${newState ? 'ON' : 'OFF'}`, 'sent');
            
            // Ghi log l√™n Google Sheets
            const outletName = outletNames[outlet] || `Outlet ${outlet}`;
            logToGoogleSheets(
                newState ? 'B·∫≠t ·ªï c·∫Øm' : 'T·∫Øt ·ªï c·∫Øm',
                outletName,
                newState ? 'ON' : 'OFF'
            );
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i "ƒëang ch·ªù"
            btn.disabled = true;
            btn.textContent = '‚è≥';
            
            // Timeout sau 3 gi√¢y n·∫øu kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi
            setTimeout(() => {
                if (btn.disabled) {
                    btn.disabled = false;
                    btn.textContent = currentState ? 'B·∫¨T' : 'T·∫ÆT';
                    showToast('‚ö†Ô∏è Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ ESP32', 'warning');
                }
            }, 3000);
        }
        
        // Cho c√° ƒÉn - v·ªõi ACK ƒë·∫£m b·∫£o th·ª±c hi·ªán
        function feedFish() {
            if (!mqttClient || !isConnected) {
                showToast('‚ö†Ô∏è Vui l√≤ng k·∫øt n·ªëi MQTT tr∆∞·ªõc!', 'warning');
                return;
            }
            
            // N·∫øu ƒëang ch·ªù x√°c nh·∫≠n l·ªánh tr∆∞·ªõc ƒë√≥
            if (pendingFeedId) {
                showToast('‚è≥ ƒêang ch·ªù x√°c nh·∫≠n l·ªánh tr∆∞·ªõc...', 'warning');
                return;
            }
            
            // T·∫°o ID duy nh·∫•t cho l·ªánh (ddMMyyHHmmss)
            // V√≠ d·ª•: 310126110601 = 31/01/26 11:06:01
            const now = new Date();
            const dd = String(now.getDate()).padStart(2, '0');
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const yy = String(now.getFullYear()).slice(-2);
            const HH = String(now.getHours()).padStart(2, '0');
            const mm = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            const feedId = `FEED_${dd}${MM}${yy}${HH}${mm}${ss}`;
            pendingFeedId = feedId;
            
            // G·ª≠i l·ªánh v·ªõi retained flag = true (ƒë·ªÉ ESP nh·∫≠n ƒë∆∞·ª£c khi k·∫øt n·ªëi l·∫°i)
            mqttClient.publish('fishfeeder/feed', feedId, { retain: true });
            addLog(`üì§ G·ª≠i l·ªánh cho ƒÉn: ${feedId}`, 'sent');
            
            // C·∫≠p nh·∫≠t UI - ƒëang ch·ªù
            const feedBtn = document.getElementById('feedBtn');
            feedBtn.disabled = true;
            feedBtn.textContent = '‚è≥ ƒêang ch·ªù...';
            
            showToast('üê† ƒêang g·ª≠i l·ªánh cho c√° ƒÉn...', 'info');
            
            // Timeout 10 gi√¢y - n·∫øu kh√¥ng nh·∫≠n ƒë∆∞·ª£c ACK
            feedTimeout = setTimeout(() => {
                if (pendingFeedId === feedId) {
                    addLog(`‚ö†Ô∏è Timeout - kh√¥ng nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n`, 'error');
                    showToast('‚ö†Ô∏è Kh√¥ng nh·∫≠n ƒë∆∞·ª£c x√°c nh·∫≠n t·ª´ ESP32. L·ªánh v·∫´n ƒë∆∞·ª£c l∆∞u, ESP s·∫Ω th·ª±c hi·ªán khi k·∫øt n·ªëi l·∫°i.', 'warning', 5000);
                    
                    // Cho ph√©p g·ª≠i l·∫°i
                    pendingFeedId = null;
                    feedBtn.disabled = false;
                    feedBtn.textContent = 'CHO ƒÇN NGAY';
                }
            }, 10000);
        }
        
        // Load c·∫•u h√¨nh t·ª´ localStorage
        window.addEventListener('load', () => {
            // Load l·∫ßn cho ƒÉn cu·ªëi t·ª´ Google Sheets ho·∫∑c localStorage
            loadLastFeedingTime();
            
            // T·ª± ƒë·ªông k·∫øt n·ªëi MQTT khi m·ªü web
            connectMQTT();
        });
        
        // L∆∞u c·∫•u h√¨nh khi thay ƒë·ªïi
        ['mqttBroker', 'mqttPort'].forEach(id => {
            document.getElementById(id).addEventListener('change', (e) => {
                localStorage.setItem(id, e.target.value);
            });
        });
    </script>
</body>
</html>
